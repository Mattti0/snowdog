<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <title>OpenStreetMap with GeoJSON</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 1000px;
        }
        .text-label {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgb(187, 187, 187);
            padding: 5px;
            font-weight: normal;
            border: 1px solid #353535;
        }
        .text-label_infence {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgb(0, 158, 21);
            padding: 5px;
            font-weight: normal;
            border: 1px solid #008612;
        }
    </style>
</head>
<body>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

<script>
    // Initialize the map
    var map = L.map('map').setView([62.777826899671936,22.80509078349192], 12);
    var globalData;
    var geojsonFeature = {"type":"FeatureCollection","features":[{"type":"Feature","properties":{"name":"start"},"geometry":{"coordinates":[[[22.80599931648257,62.77830042353017],[22.80509078349192,62.777826899671936],[22.806043540984263,62.77714709318019],[22.80707143209338,62.77726252476188],[22.806969791868255,62.77754842923386],[22.80599931648257,62.77830042353017]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s13"},"geometry":{"coordinates":[[[22.778724430165965,62.761038812380605],[22.77893843323102,62.7605613034099],[22.77754741330031,62.760500083751964],[22.77682515295109,62.76089188736688],[22.77637039643625,62.7613449038092],[22.774899125354636,62.76184688687496],[22.774016362706533,62.762055023689186],[22.77425711615632,62.76155304416585],[22.776718151418578,62.76018173948228],[22.779607192814012,62.759961345283244],[22.779853169975496,62.76075086499142],[22.778724430165965,62.761038812380605]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s15"},"geometry":{"coordinates":[[[22.77007470947737,62.762943526385016],[22.771010972891702,62.7622701575485],[22.775612038818508,62.76495129855931],[22.774595524253215,62.767081346426096],[22.77499678000183,62.768635939406465],[22.773770718789365,62.768695404593075],[22.77336500662136,62.76579599112236],[22.77443502195291,62.765098203351954],[22.77109122404258,62.76364136513877],[22.77007470947737,62.762943526385016]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s16","label":"derp"},"geometry":{"coordinates":[[[22.774007009294905,62.768697111929725],[22.77617379034112,62.76861142801462],[22.77922333403538,62.771610216900314],[22.7802130982175,62.77496360318861],[22.78227287773123,62.777655827041855],[22.77641454379085,62.777264246126975],[22.773378375286626,62.77642600112276],[22.771813477864043,62.769076566275544],[22.774007009294905,62.768697111929725]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s9"},"geometry":{"coordinates":[[[22.79866729567715,62.768722328848696],[22.790581293396286,62.76439731259032],[22.79182394742722,62.76399681603445],[22.79978743452085,62.768546136853956],[22.79866729567715,62.768722328848696]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":1},"geometry":{"coordinates":[[[22.806996170467528,62.77752227152203],[22.80706205534139,62.7772895236279],[22.808586930544777,62.77716196932411],[22.80985987751876,62.77674602877306],[22.80995080230295,62.77616370214102],[22.811223749277815,62.77549817190251],[22.811981455810184,62.77580320846042],[22.81046604274468,62.77645486689508],[22.810647892313085,62.77688467627573],[22.80910217098642,62.77739766636404],[22.807920148796683,62.77739766636404],[22.807348283280305,62.777522128586355],[22.806996170467528,62.77752227152203]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s2"},"geometry":{"coordinates":[[[22.8119869949017,62.775771353264275],[22.811238539820124,62.775485145314775],[22.81091757371823,62.77560227383836],[22.808784482256897,62.7743476520634],[22.80946023088549,62.77432727157236],[22.810024818796876,62.77481225665909],[22.81084188198605,62.77519090605975],[22.811727901282666,62.7752922829859],[22.8119869949017,62.775771353264275]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s3"},"geometry":{"coordinates":[[[22.80896026750966,62.774329691426516],[22.806979008839846,62.77323621373321],[22.807314460042534,62.77305875958078],[22.809473927165527,62.774315303825546],[22.80896026750966,62.774329691426516]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s4"},"geometry":{"coordinates":[[[22.8073120436043,62.773431692301244],[22.80494533591866,62.77394601966199],[22.804809058866823,62.77369183436812],[22.806936050673215,62.77321801465544],[22.8073120436043,62.773431692301244]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s5"},"geometry":{"coordinates":[[[22.8047163969658,62.77370932993878],[22.804557470464516,62.77333693047976],[22.80545899557336,62.77267507127456],[22.80588879242771,62.77243046737303],[22.80627665788188,62.77237770940272],[22.806140380831238,62.77266547900297],[22.80528193529804,62.77357998329856],[22.8047163969658,62.77370932993878]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s6"},"geometry":{"coordinates":[[[22.805750809417134,62.772450953696705],[22.803560087678648,62.7711934733978],[22.803901740119244,62.77103043459434],[22.806280372480614,62.77236738739674],[22.805750809417134,62.772450953696705]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s7"},"geometry":{"coordinates":[[[22.803558060485813,62.77118416221322],[22.801513904714568,62.770152922997056],[22.80185538175965,62.769986916895334],[22.80387254598844,62.77103067773098],[22.803558060485813,62.77118416221322]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s8"},"geometry":{"coordinates":[[[22.801513904714568,62.77014332990487],[22.80065431100587,62.77008577128575],[22.800109202799774,62.76948139900034],[22.798694018036116,62.76883864027786],[22.798690740137204,62.76872976643173],[22.799218098760775,62.76864739531234],[22.800507551103948,62.769351889041616],[22.800801070907653,62.7697644002636],[22.80183887306839,62.76998024685855],[22.801513904714568,62.77014332990487]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s10"},"geometry":{"coordinates":[[[22.790899226544212,62.764581193884396],[22.787905483776868,62.7646826085539],[22.787512803738537,62.76444406971768],[22.788008473888397,62.764028855312176],[22.79083781657684,62.76429027034854],[22.790557790529263,62.76440059961398],[22.790899226544212,62.764581193884396]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s11"},"geometry":{"coordinates":[[[22.787589548983874,62.76450358877318],[22.788927068149775,62.76532381028622],[22.788097806266506,62.76611952577366],[22.78638578173664,62.76603383436833],[22.784489550954532,62.764733765947824],[22.785329730503435,62.76448467185989],[22.78662653518637,62.76554416441712],[22.787750051284206,62.76536053608913],[22.787001040551843,62.76477291775561],[22.787589548983874,62.76450358877318]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s12"},"geometry":{"coordinates":[[[22.7844490121891,62.76473618425703],[22.781666972327685,62.76338951306957],[22.77875118054908,62.76105105609901],[22.779847946263743,62.76075720546132],[22.785385275604938,62.764454612638986],[22.7844490121891,62.76473618425703]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s14"},"geometry":{"coordinates":[[[22.77399188822855,62.76207270881028],[22.77329410235734,62.76147958303122],[22.771009476346165,62.76225832706291],[22.77060281689421,62.76256760270397],[22.769812881742993,62.763091915341036],[22.769190576011198,62.762884295311665],[22.769789802146676,62.76181015669627],[22.773829110023144,62.76092861868909],[22.774457839821423,62.76142612415012],[22.774240033426324,62.76154394279801],[22.77399188822855,62.76207270881028]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s17"},"geometry":{"coordinates":[[[22.781533613992195,62.77779909672253],[22.78231677793596,62.77766835222374],[22.781729670242896,62.776898806822004],[22.78707132040222,62.77621756473425],[22.789580115571965,62.77707132263083],[22.78832571798668,62.77754717695518],[22.78746905622205,62.7770013434058],[22.785572162313116,62.77728125930915],[22.782940986891845,62.777925055798846],[22.781533613992195,62.77779909672253]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s19"},"geometry":{"coordinates":[[[22.798895452083485,62.77755845136193],[22.801676148876794,62.77710218002298],[22.804001277002925,62.77690246968017],[22.80599591564831,62.777173948473234],[22.805095602682115,62.77781959211134],[22.80092052474808,62.77844332109947],[22.796859142346477,62.78015895201344],[22.797475167745887,62.779605582080904],[22.796789428033833,62.779354224678514],[22.798895452083485,62.77755845136193]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"telakka"},"geometry":{"coordinates":[[[22.81712562837521,62.77912523647137],[22.814883774331776,62.77799543269904],[22.81771960066257,62.77728437219773],[22.81927394275482,62.77853742963569],[22.81712562837521,62.77912523647137]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"s18"},"geometry":{"coordinates":[[[22.788050362419995,62.77770112817993],[22.789916661265238,62.77693136401459],[22.797473641836547,62.779618453334905],[22.79676995538628,62.780164238418564],[22.7919359354257,62.778806754260415],[22.788050362419995,62.77770112817993]]],"type":"Polygon"}},{"type":"Feature","properties":{"name":"Frami"},"geometry":{"coordinates":[[[22.824536214689402,62.78602416722822],[22.82463258204396,62.787064960877984],[22.8243113023118,62.788159577208575],[22.823069592185362,62.79060439024289],[22.819546011999677,62.790626840171086],[22.819010814138323,62.78845038241394],[22.81927800452405,62.785810638304724],[22.824536214689402,62.78602416722822]]],"type":"Polygon"},"id":21},{"type":"Feature","properties":{"name":"Kertunlaakso"},"geometry":{"coordinates":[[[22.90853507061425,62.810510672234386],[22.902831630687302,62.807887643131295],[22.90271096677924,62.807325717182295],[22.920398358152823,62.80098902947768],[22.92589486845148,62.80182328493882],[22.922384959865923,62.80421758106948],[22.921273467276933,62.80584423854745],[22.919252934811595,62.806692147137625],[22.915077424608057,62.80738110222333],[22.911252666635193,62.80948638891698],[22.910049109564653,62.809823131913504],[22.90853507061425,62.810510672234386]]],"type":"Polygon"},"id":22},{"type":"Feature","properties":{"name":"Itikanristeys"},"geometry":{"coordinates":[[[22.82870878293778,62.79521872870393],[22.824754603892643,62.79439076313727],[22.825820297836174,62.7936570694697],[22.829620412968552,62.79469270974826],[22.82870878293778,62.79521872870393]]],"type":"Polygon"},"id":23}]};
    var geojsonobjects = [];
    geojsonobjects.polygons = [];
    geojsonobjects.markers = [];

    // Add OpenStreetMap tile layer
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Example GeoJSON data


    for (var i = 0; i < geojsonFeature.features.length; i++) {
            //console.log(trailfences.features[i]);
            //console.log(geojsonFeature.features[i].properties.name);
            var defaultColor = "rgb(73, 73, 73)";
            geojsonFeature.features[i].properties.fill = defaultColor;
            geojsonFeature.features[i].properties.fillColor = defaultColor;
            geojsonFeature.features[i].properties.color = defaultColor;
            geojsonFeature.features[i].properties.tooltipContent = "";
            geojsonFeature.features[i].properties.fillOpacity = 0.41;
            geojsonFeature.features[i].properties.weight = 1;

        //console.log(geojsonFeature.features[i]);
        var active = 'text-label';
        //if (geojsonFeature.features[i].properties.name == "Kertunlaakso") {
        //    var active = 'text-label_infence';
        //}
        var textLayer = L.divIcon({
            className: active,
            html: '<div>'+geojsonFeature.features[i].properties.name+'</div>'
        });
        geojsonobjects.markers[geojsonFeature.features[i].properties.name] = L.marker([geojsonFeature.features[i].geometry.coordinates[0][0][1], geojsonFeature.features[i].geometry.coordinates[0][0][0]], {icon: textLayer}).addTo(map);
        //L.geoJSON(geojsonFeature.features[i]).addTo(map);

        geojsonobjects.polygons[geojsonFeature.features[i].properties.name] = L.geoJSON(geojsonFeature.features[i], {
        style: function (feature) {
            return {
                fillColor: feature.properties.fillColor, // Set the fill color to red, or use the specified fill color in the properties
                weight: feature.properties.weight,
                opacity: feature.properties.fillOpacity1,
                color: feature.properties.color,
                fillOpacity: feature.properties.fillOpacity
            };
        }
        }).addTo(map);
    }
    //console.log(geojsonobjects);

    
    function calculateColor(timestamp) {
        // Calculate the time difference in milliseconds
        const currentTime = new Date().getTime();
        const timeDifference = currentTime - timestamp;

        // Maximum time for a full transition to red (24 * 3 (3 days) hours in milliseconds)
        const maxTimeForFullRed = 24 * 3 * 60 * 60 * 1000;

        // Calculate the color value between red and green based on time
        let colorValue = Math.min(1, timeDifference / maxTimeForFullRed);

        // Calculate the RGB values based on the colorValue
        const green = Math.round(255 * (1 - colorValue));
        const red = Math.round(255 * colorValue);
        const blue = 0; // Blue component is set to 0

        // Return the color value as an RGB string
        return `rgb(${red}, ${green}, ${blue})`;
    }

    function calculateColorForMarker(timestamp) {
        // Calculate the time difference in milliseconds
        const currentTime = new Date().getTime();
        const timeDifference = currentTime - timestamp;

        // Maximum time for a full transition to red (24 * 3 (3 days) hours in milliseconds)
        const maxTimeForFullRed =  30 * 1000;

        if (timeDifference < maxTimeForFullRed) {
            return "text-label_infence";
        }
        else {
            return "text-label";
        }

    }



    function checkColors() {
        axios.get('/snowdog/api.php?geojson=1&apikey=1234')
        .then(response => {
            // Handle the JSON data
            for (var i = 0; i < response.data.length; i++) {

                const dateObject = new Date(response.data[i].latest_ts);
                const color = calculateColor(dateObject.getTime());

                try {
                    var updatestring = "Viimeksi käyty:<br>"+response.data[i].latest_ts;
                    geojsonobjects.polygons[response.data[i].in_area].setStyle({fillColor: color});
                    geojsonobjects.polygons[response.data[i].in_area].bindPopup(updatestring);

                    var textLayer = L.divIcon({
                        className: calculateColorForMarker(dateObject.getTime()),
                        html: '<div>'+response.data[i].in_area+'</div>'
                    });

                    geojsonobjects.markers[response.data[i].in_area].setIcon(textLayer);
                    geojsonobjects.markers[response.data[i].in_area].bindPopup(updatestring);


                } catch (error) {
                    //console.log(error);
                }
            }
        })
        .catch(error => {
            // Handle errors
            console.error('Axios error:', error);
        });
        }

        // Set a two-second timer
    checkColors();
    setInterval(checkColors, 10000);

</script>

</body>

</html>